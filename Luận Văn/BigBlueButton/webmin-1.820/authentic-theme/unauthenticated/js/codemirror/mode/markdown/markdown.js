(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("../xml/xml"),require("../meta"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","../xml/xml","../meta"],a)}else{a(CodeMirror)}}})(function(a){a.defineMode("markdown",function(y,z){var p=a.modes.hasOwnProperty("xml");var j=a.getMode(y,p?{name:"xml",htmlMode:true}:"text/plain");function F(X){if(a.findModeByName){var Y=a.findModeByName(X);if(Y){X=Y.mime||Y.mimes[0]}}var Z=a.getMode(y,X);return Z.name=="null"?null:Z}if(z.highlightFormatting===undefined){z.highlightFormatting=false}if(z.maxBlockquoteDepth===undefined){z.maxBlockquoteDepth=0}if(z.underscoresBreakWords===undefined){z.underscoresBreakWords=true}if(z.fencedCodeBlocks===undefined){z.fencedCodeBlocks=false}if(z.taskLists===undefined){z.taskLists=false}if(z.strikethrough===undefined){z.strikethrough=false}var k=0;var i="header",g="comment",r="quote",Q="variable-2",N="variable-3",M="keyword",P="hr",h="tag",u="formatting",q="link",m="link",G="link",E="string",R="em",A="strong",n="strikethrough";var b=/^([*\-_])(?:\s*\1){2,}\s*$/,e=/^[*\-+]\s+/,C=/^[0-9]+([.)])\s+/,t=/^\[(x| )\](?=\s)/,T=/^(#+)(?: |$)/,W=/^ *(?:\={1,}|-{1,})\s*$/,B=/^[^#!\[\]*_\\<>` "'(~]+/;function U(Z,Y,X){Y.f=Y.inline=X;return X(Z,Y)}function D(Z,Y,X){Y.f=Y.block=X;return X(Z,Y)}function c(X){X.linkTitle=false;X.em=false;X.strong=false;X.strikethrough=false;X.quote=0;X.indentedCode=false;if(!p&&X.f==s){X.f=S;X.block=J}X.trailingSpace=0;X.trailingSpaceNewLine=false;X.thisLineHasContent=false;return null}function J(ad,ac){var ab=ad.sol();var Z=ac.list!==false,X=ac.indentedCode;ac.indentedCode=false;if(Z){if(ac.indentationDiff>=0){if(ac.indentationDiff<4){ac.indentation-=ac.indentationDiff}ac.list=null}else{if(ac.indentation>0){ac.list=null;ac.listDepth=Math.floor(ac.indentation/4)}else{ac.list=false;ac.listDepth=0}}}var Y=null;if(ac.indentationDiff>=4){ad.skipToEnd();if(X||!ac.prevLineHasContent){ac.indentation-=4;ac.indentedCode=true;return g}else{return null}}else{if(ad.eatSpace()){return null}else{if((Y=ad.match(T))&&Y[1].length<=6){ac.header=Y[1].length;if(z.highlightFormatting){ac.formatting="header"}ac.f=ac.inline;return w(ac)}else{if(ac.prevLineHasContent&&!ac.quote&&!Z&&!X&&(Y=ad.match(W))){ac.header=Y[0].charAt(0)=="="?1:2;if(z.highlightFormatting){ac.formatting="header"}ac.f=ac.inline;return w(ac)}else{if(ad.eat(">")){ac.quote=ab?1:ac.quote+1;if(z.highlightFormatting){ac.formatting="quote"}ad.eatSpace();return w(ac)}else{if(ad.peek()==="["){return U(ad,ac,d)}else{if(ad.match(b,true)){ac.hr=true;return P}else{if((!ac.prevLineHasContent||Z)&&(ad.match(e,false)||ad.match(C,false))){var aa=null;if(ad.match(e,true)){aa="ul"}else{ad.match(C,true);aa="ol"}ac.indentation+=4;ac.list=true;ac.listDepth++;if(z.taskLists&&ad.match(t,false)){ac.taskList=true}ac.f=ac.inline;if(z.highlightFormatting){ac.formatting=["list","list-"+aa]}return w(ac)}else{if(z.fencedCodeBlocks&&ad.match(/^```[ \t]*([\w+#]*)/,true)){ac.localMode=F(RegExp.$1);if(ac.localMode){ac.localState=ac.localMode.startState()}ac.f=ac.block=I;if(z.highlightFormatting){ac.formatting="code-block"}ac.code=true;return w(ac)}}}}}}}}}return U(ad,ac,ac.inline)}function s(Z,Y){var X=j.token(Z,Y.htmlState);if((p&&Y.htmlState.tagStart===null&&!Y.htmlState.context)||(Y.md_inside&&Z.current().indexOf(">")>-1)){Y.f=S;Y.block=J;Y.htmlState=null}return X}function I(Y,X){if(Y.sol()&&Y.match("```",false)){X.localMode=X.localState=null;X.f=X.block=O;return null}else{if(X.localMode){return X.localMode.token(Y,X.localState)}else{Y.skipToEnd();return g}}}function O(Z,Y){Z.match("```");Y.block=J;Y.f=S;if(z.highlightFormatting){Y.formatting="code-block"}Y.code=true;var X=w(Y);Y.code=false;return X}function w(aa){var Z=[];if(aa.formatting){Z.push(u);if(typeof aa.formatting==="string"){aa.formatting=[aa.formatting]}for(var X=0;X<aa.formatting.length;X++){Z.push(u+"-"+aa.formatting[X]);if(aa.formatting[X]==="header"){Z.push(u+"-"+aa.formatting[X]+"-"+aa.header)}if(aa.formatting[X]==="quote"){if(!z.maxBlockquoteDepth||z.maxBlockquoteDepth>=aa.quote){Z.push(u+"-"+aa.formatting[X]+"-"+aa.quote)}else{Z.push("error")}}}}if(aa.taskOpen){Z.push("meta");return Z.length?Z.join(" "):null}if(aa.taskClosed){Z.push("property");return Z.length?Z.join(" "):null}if(aa.linkHref){Z.push(E,"url")}else{if(aa.strong){Z.push(A)}if(aa.em){Z.push(R)}if(aa.strikethrough){Z.push(n)}if(aa.linkText){Z.push(G)}if(aa.code){Z.push(g)}}if(aa.header){Z.push(i);Z.push(i+"-"+aa.header)}if(aa.quote){Z.push(r);if(!z.maxBlockquoteDepth||z.maxBlockquoteDepth>=aa.quote){Z.push(r+"-"+aa.quote)}else{Z.push(r+"-"+z.maxBlockquoteDepth)}}if(aa.list!==false){var Y=(aa.listDepth-1)%3;if(!Y){Z.push(Q)}else{if(Y===1){Z.push(N)}else{Z.push(M)}}}if(aa.trailingSpaceNewLine){Z.push("trailing-space-new-line")}else{if(aa.trailingSpace){Z.push("trailing-space-"+(aa.trailingSpace%2?"a":"b"))}}return Z.length?Z.join(" "):null}function o(Y,X){if(Y.match(B,true)){return w(X)}return undefined}function S(am,Y){var Z=Y.text(am,Y);if(typeof Z!=="undefined"){return Z}if(Y.list){Y.list=null;return w(Y)}if(Y.taskList){var ac=am.match(t,true)[1]!=="x";if(ac){Y.taskOpen=true}else{Y.taskClosed=true}if(z.highlightFormatting){Y.formatting="task"}Y.taskList=false;return w(Y)}Y.taskOpen=false;Y.taskClosed=false;if(Y.header&&am.match(/^#+$/,true)){if(z.highlightFormatting){Y.formatting="header"}return w(Y)}var ae=am.sol();var X=am.next();if(X==="\\"){am.next();if(z.highlightFormatting){var af=w(Y);return af?af+" formatting-escape":"formatting-escape"}}if(Y.linkTitle){Y.linkTitle=false;var ai=X;if(X==="("){ai=")"}ai=(ai+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");var ah="^\\s*(?:[^"+ai+"\\\\]+|\\\\\\\\|\\\\.)"+ai;if(am.match(new RegExp(ah),true)){return E}}if(X==="`"){var ak=Y.formatting;if(z.highlightFormatting){Y.formatting="code"}var an=w(Y);var ag=am.pos;am.eatWhile("`");var aa=1+am.pos-ag;if(!Y.code){k=aa;Y.code=true;return w(Y)}else{if(aa===k){Y.code=false;return an}Y.formatting=ak;return w(Y)}}else{if(Y.code){return w(Y)}}if(X==="!"&&am.match(/\[[^\]]*\] ?(?:\(|\[)/,false)){am.match(/\[[^\]]*\]/);Y.inline=Y.f=x;return h}if(X==="["&&am.match(/.*\](\(.*\)| ?\[.*\])/,false)){Y.linkText=true;if(z.highlightFormatting){Y.formatting="link"}return w(Y)}if(X==="]"&&Y.linkText&&am.match(/\(.*\)| ?\[.*\]/,false)){if(z.highlightFormatting){Y.formatting="link"}var af=w(Y);Y.linkText=false;Y.inline=Y.f=x;return af}if(X==="<"&&am.match(/^(https?|ftps?):\/\/(?:[^\\>]|\\.)+>/,false)){Y.f=Y.inline=L;if(z.highlightFormatting){Y.formatting="link"}var af=w(Y);if(af){af+=" "}else{af=""}return af+q}if(X==="<"&&am.match(/^[^> \\]+@(?:[^\\>]|\\.)+>/,false)){Y.f=Y.inline=L;if(z.highlightFormatting){Y.formatting="link"}var af=w(Y);if(af){af+=" "}else{af=""}return af+m}if(X==="<"&&am.match(/^\w/,false)){if(am.string.indexOf(">")!=-1){var ad=am.string.substring(1,am.string.indexOf(">"));if(/markdown\s*=\s*('|"){0,1}1('|"){0,1}/.test(ad)){Y.md_inside=true}}am.backUp(1);Y.htmlState=a.startState(j);return D(am,Y,s)}if(X==="<"&&am.match(/^\/\w*?>/)){Y.md_inside=false;return"tag"}var ab=false;if(!z.underscoresBreakWords){if(X==="_"&&am.peek()!=="_"&&am.match(/(\w)/,false)){var aj=am.pos-2;if(aj>=0){var al=am.string.charAt(aj);if(al!=="_"&&al.match(/(\w)/,false)){ab=true}}}}if(X==="*"||(X==="_"&&!ab)){if(ae&&am.peek()===" "){}else{if(Y.strong===X&&am.eat(X)){if(z.highlightFormatting){Y.formatting="strong"}var an=w(Y);Y.strong=false;return an}else{if(!Y.strong&&am.eat(X)){Y.strong=X;if(z.highlightFormatting){Y.formatting="strong"}return w(Y)}else{if(Y.em===X){if(z.highlightFormatting){Y.formatting="em"}var an=w(Y);Y.em=false;return an}else{if(!Y.em){Y.em=X;if(z.highlightFormatting){Y.formatting="em"}return w(Y)}}}}}}else{if(X===" "){if(am.eat("*")||am.eat("_")){if(am.peek()===" "){return w(Y)}else{am.backUp(1)}}}}if(z.strikethrough){if(X==="~"&&am.eatWhile(X)){if(Y.strikethrough){if(z.highlightFormatting){Y.formatting="strikethrough"}var an=w(Y);Y.strikethrough=false;return an}else{if(am.match(/^[^\s]/,false)){Y.strikethrough=true;if(z.highlightFormatting){Y.formatting="strikethrough"}return w(Y)}}}else{if(X===" "){if(am.match(/^~~/,true)){if(am.peek()===" "){return w(Y)}else{am.backUp(2)}}}}}if(X===" "){if(am.match(/ +$/,false)){Y.trailingSpace++}else{if(Y.trailingSpace){Y.trailingSpaceNewLine=true}}}return w(Y)}function L(aa,Z){var Y=aa.next();if(Y===">"){Z.f=Z.inline=S;if(z.highlightFormatting){Z.formatting="link"}var X=w(Z);if(X){X+=" "}else{X=""}return X+q}aa.match(/^[^>]+/,true);return q}function x(Z,Y){if(Z.eatSpace()){return null}var X=Z.next();if(X==="("||X==="["){Y.f=Y.inline=K(X==="("?")":"]");if(z.highlightFormatting){Y.formatting="link-string"}Y.linkHref=true;return w(Y)}return"error"}function K(X){return function(ab,aa){var Z=ab.next();if(Z===X){aa.f=aa.inline=S;if(z.highlightFormatting){aa.formatting="link-string"}var Y=w(aa);aa.linkHref=false;return Y}if(ab.match(v(X),true)){ab.backUp(1)}aa.linkHref=true;return w(aa)}}function d(Y,X){if(Y.match(/^[^\]]*\]:/,false)){X.f=H;Y.next();if(z.highlightFormatting){X.formatting="link"}X.linkText=true;return w(X)}return U(Y,X,S)}function H(Z,Y){if(Z.match(/^\]:/,true)){Y.f=Y.inline=f;if(z.highlightFormatting){Y.formatting="link"}var X=w(Y);Y.linkText=false;return X}Z.match(/^[^\]]+/,true);return G}function f(Y,X){if(Y.eatSpace()){return null}Y.match(/^[^\s]+/,true);if(Y.peek()===undefined){X.linkTitle=true}else{Y.match(/^(?:\s+(?:"(?:[^"\\]|\\\\|\\.)+"|'(?:[^'\\]|\\\\|\\.)+'|\((?:[^)\\]|\\\\|\\.)+\)))?/,true)}X.f=X.inline=S;return E+" url"}var V=[];function v(X){if(!V[X]){X=(X+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");V[X]=new RegExp("^(?:[^\\\\]|\\\\.)*?("+X+")")}return V[X]}var l={startState:function(){return{f:J,prevLineHasContent:false,thisLineHasContent:false,block:J,htmlState:null,indentation:0,inline:S,text:o,formatting:false,linkText:false,linkHref:false,linkTitle:false,em:false,strong:false,header:0,hr:false,taskList:false,list:false,listDepth:0,quote:0,trailingSpace:0,trailingSpaceNewLine:false,strikethrough:false}},copyState:function(X){return{f:X.f,prevLineHasContent:X.prevLineHasContent,thisLineHasContent:X.thisLineHasContent,block:X.block,htmlState:X.htmlState&&a.copyState(j,X.htmlState),indentation:X.indentation,localMode:X.localMode,localState:X.localMode?a.copyState(X.localMode,X.localState):null,inline:X.inline,text:X.text,formatting:false,linkTitle:X.linkTitle,em:X.em,strong:X.strong,strikethrough:X.strikethrough,header:X.header,hr:X.hr,taskList:X.taskList,list:X.list,listDepth:X.listDepth,quote:X.quote,indentedCode:X.indentedCode,trailingSpace:X.trailingSpace,trailingSpaceNewLine:X.trailingSpaceNewLine,md_inside:X.md_inside}},token:function(ab,aa){aa.formatting=false;if(ab.sol()){var X=!!aa.header||aa.hr;aa.header=0;aa.hr=false;if(ab.match(/^\s*$/,true)||X){aa.prevLineHasContent=false;c(aa);return X?this.token(ab,aa):null}else{aa.prevLineHasContent=aa.thisLineHasContent;aa.thisLineHasContent=true}aa.taskList=false;aa.code=false;aa.trailingSpace=0;aa.trailingSpaceNewLine=false;aa.f=aa.block;var Y=ab.match(/^\s*/,true)[0].replace(/\t/g,"    ").length;var ac=Math.floor((Y-aa.indentation)/4)*4;if(ac>4){ac=4}var Z=aa.indentation+ac;aa.indentationDiff=Z-aa.indentation;aa.indentation=Z;if(Y>0){return null}}return aa.f(ab,aa)},innerMode:function(X){if(X.block==s){return{state:X.htmlState,mode:j}}if(X.localState){return{state:X.localState,mode:X.localMode}}return{state:X,mode:l}},blankLine:c,getType:w,fold:"markdown"};return l},"xml");a.defineMIME("text/x-markdown","markdown")});