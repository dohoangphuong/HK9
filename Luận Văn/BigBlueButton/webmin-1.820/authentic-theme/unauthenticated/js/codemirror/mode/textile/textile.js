(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],a)}else{a(CodeMirror)}}})(function(e){var g={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"};function m(o,n){n.mode=l.newLayout;n.tableHeading=false;if(n.layoutType==="definitionList"&&n.spanningLayout&&o.match(f("definitionListEnd"),false)){n.spanningLayout=false}}function c(r,q,p){if(p==="_"){if(r.eat("_")){return a(r,q,"italic",/__/,2)}else{return a(r,q,"em",/_/,1)}}if(p==="*"){if(r.eat("*")){return a(r,q,"bold",/\*\*/,2)}return a(r,q,"strong",/\*/,1)}if(p==="["){if(r.match(/\d+\]/)){q.footCite=true}return b(q)}if(p==="("){var n=r.match(/^(r|tm|c)\)/);if(n){return j(q,g.specialChar)}}if(p==="<"&&r.match(/(\w+)[^>]+>[^<]+<\/\1>/)){return j(q,g.html)}if(p==="?"&&r.eat("?")){return a(r,q,"cite",/\?\?/,2)}if(p==="="&&r.eat("=")){return a(r,q,"notextile",/==/,2)}if(p==="-"&&!r.eat("-")){return a(r,q,"deletion",/-/,1)}if(p==="+"){return a(r,q,"addition",/\+/,1)}if(p==="~"){return a(r,q,"sub",/~/,1)}if(p==="^"){return a(r,q,"sup",/\^/,1)}if(p==="%"){return a(r,q,"span",/%/,1)}if(p==="@"){return a(r,q,"code",/@/,1)}if(p==="!"){var o=a(r,q,"image",/(?:\([^\)]+\))?!/,1);r.match(/^:\S+/);return o}return b(q)}function a(u,s,o,t,n){var q=u.pos>n?u.string.charAt(u.pos-n-1):null;var p=u.peek();if(s[o]){if((!p||/\W/.test(p))&&q&&/\S/.test(q)){var r=b(s);s[o]=false;return r}}else{if((!q||/\W/.test(q))&&p&&/\S/.test(p)&&u.match(new RegExp("^.*\\S"+t.source+"(?:\\W|$)"),false)){s[o]=true;s.mode=l.attributes}}return b(s)}function b(p){var n=h(p);if(n){return n}var o=[];if(p.layoutType){o.push(g[p.layoutType])}o=o.concat(i(p,"addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","strong","sub","sup","table","tableHeading"));if(p.layoutType==="header"){o.push(g.header+"-"+p.header)}return o.length?o.join(" "):null}function h(o){var n=o.layoutType;switch(n){case"notextile":case"code":case"pre":return g[n];default:if(o.notextile){return g.notextile+(n?(" "+g[n]):"")}return null}}function j(q,p){var o=h(q);if(o){return o}var n=b(q);if(p){return n?(n+" "+p):p}else{return n}}function i(p){var o=[];for(var n=1;n<arguments.length;++n){if(p[arguments[n]]){o.push(g[arguments[n]])}}return o}function d(p){var q=p.spanningLayout,o=p.layoutType;for(var n in p){if(p.hasOwnProperty(n)){delete p[n]}}p.mode=l.newLayout;if(q){p.layoutType=o;p.spanningLayout=true}}var k={cache:{},single:{bc:"bc",bq:"bq",definitionList:/- [^(?::=)]+:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[\/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/},attributes:{align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/},createRe:function(n){switch(n){case"drawTable":return k.makeRe("^",k.single.drawTable,"$");case"html":return k.makeRe("^",k.single.html,"(?:",k.single.html,")*","$");case"linkDefinition":return k.makeRe("^",k.single.linkDefinition,"$");case"listLayout":return k.makeRe("^",k.single.list,f("allAttributes"),"*\\s+");case"tableCellAttributes":return k.makeRe("^",k.choiceRe(k.single.tableCellAttributes,f("allAttributes")),"+\\.");case"type":return k.makeRe("^",f("allTypes"));case"typeLayout":return k.makeRe("^",f("allTypes"),f("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return k.makeRe("^",f("allAttributes"),"+");case"allTypes":return k.choiceRe(k.single.div,k.single.foot,k.single.header,k.single.bc,k.single.bq,k.single.notextile,k.single.pre,k.single.table,k.single.para);case"allAttributes":return k.choiceRe(k.attributes.selector,k.attributes.css,k.attributes.lang,k.attributes.align,k.attributes.pad);default:return k.makeRe("^",k.single[n])}},makeRe:function(){var p="";for(var o=0;o<arguments.length;++o){var n=arguments[o];p+=(typeof n==="string")?n:n.source}return new RegExp(p)},choiceRe:function(){var o=[arguments[0]];for(var n=1;n<arguments.length;++n){o[n*2-1]="|";o[n*2]=arguments[n]}o.unshift("(?:");o.push(")");return k.makeRe.apply(null,o)}};function f(n){return(k.cache[n]||(k.cache[n]=k.createRe(n)))}var l={newLayout:function(p,o){if(p.match(f("typeLayout"),false)){o.spanningLayout=false;return(o.mode=l.blockType)(p,o)}var n;if(!h(o)){if(p.match(f("listLayout"),false)){n=l.list}else{if(p.match(f("drawTable"),false)){n=l.table}else{if(p.match(f("linkDefinition"),false)){n=l.linkDefinition}else{if(p.match(f("definitionList"))){n=l.definitionList}else{if(p.match(f("html"),false)){n=l.html}}}}}}return(o.mode=(n||l.text))(p,o)},blockType:function(q,p){var n,o;p.layoutType=null;if(n=q.match(f("type"))){o=n[0]}else{return(p.mode=l.text)(q,p)}if(n=o.match(f("header"))){p.layoutType="header";p.header=parseInt(n[0][1])}else{if(o.match(f("bq"))){p.layoutType="quote"}else{if(o.match(f("bc"))){p.layoutType="code"}else{if(o.match(f("foot"))){p.layoutType="footnote"}else{if(o.match(f("notextile"))){p.layoutType="notextile"}else{if(o.match(f("pre"))){p.layoutType="pre"}else{if(o.match(f("div"))){p.layoutType="div"}else{if(o.match(f("table"))){p.layoutType="table"}}}}}}}}p.mode=l.attributes;return b(p)},text:function(p,o){if(p.match(f("text"))){return b(o)}var n=p.next();if(n==='"'){return(o.mode=l.link)(p,o)}return c(p,o,n)},attributes:function(o,n){n.mode=l.layoutLength;if(o.match(f("attributes"))){return j(n,g.attributes)}else{return b(n)}},layoutLength:function(o,n){if(o.eat(".")&&o.eat(".")){n.spanningLayout=true}n.mode=l.text;return b(n)},list:function(q,p){var n=q.match(f("list"));p.listDepth=n[0].length;var o=(p.listDepth-1)%3;if(!o){p.layoutType="list1"}else{if(o===1){p.layoutType="list2"}else{p.layoutType="list3"}}p.mode=l.attributes;return b(p)},link:function(o,n){n.mode=l.text;if(o.match(f("link"))){o.match(/\S+/);return j(n,g.link)}return b(n)},linkDefinition:function(o,n){o.skipToEnd();return j(n,g.linkDefinition)},definitionList:function(o,n){o.match(f("definitionList"));n.layoutType="definitionList";if(o.match(/\s*$/)){n.spanningLayout=true}else{n.mode=l.attributes}return b(n)},html:function(o,n){o.skipToEnd();return j(n,g.html)},table:function(o,n){n.layoutType="table";return(n.mode=l.tableCell)(o,n)},tableCell:function(o,n){if(o.match(f("tableHeading"))){n.tableHeading=true}else{o.eat("|")}n.mode=l.tableCellAttributes;return b(n)},tableCellAttributes:function(o,n){n.mode=l.tableText;if(o.match(f("tableCellAttributes"))){return j(n,g.attributes)}else{return b(n)}},tableText:function(o,n){if(o.match(f("tableText"))){return b(n)}if(o.peek()==="|"){n.mode=l.tableCell;return b(n)}return c(o,n,o.next())}};e.defineMode("textile",function(){return{startState:function(){return{mode:l.newLayout}},token:function(o,n){if(o.sol()){m(o,n)}return n.mode(o,n)},blankLine:d}});e.defineMIME("text/x-textile","textile")});